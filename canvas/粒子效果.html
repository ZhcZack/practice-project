<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>粒子效果</title>
	<style>
		body {
			background-color: gray;
		}

		canvas {
			border: 1px solid black;
		}
	</style>
</head>

<body>
	<canvas id="particle" width="800" height="600"></canvas>
	<script>
		function randomBetween(a, b) {
			return Math.floor(Math.random() * (b - a + 1) + a)
		}
		const log = console.log.bind(console)
		class Process {
			constructor() {
				this.setup()
			}
			setup() {
				this.canvas = document.querySelector('#particle')
				this.context = this.canvas.getContext('2d')
				this.scene = null
			}
			runloop() {
				this.update()
				this.clear()
				this.draw()
				setTimeout(() => {
					this.runloop()
				}, 1000 / 60)
			}
			__start() {
				this.runloop()
			}
			update() {
				this.scene.update()
			}
			clear() {
				this.scene.clear()
			}
			draw() {
				this.scene.draw()
			}
			runWithScene(s) {
				this.scene = s
				this.__start()
			}
		}

		class Scene {
			constructor(process) {
				this.process = process
				this.elements = []
				this.setup()
			}
			setup() {
				let ps = new ParticleSystem(this)
				this.addElement(ps)
			}
			addElement(elem) {
				this.elements.push(elem)
			}
			update() {
				this.elements.forEach(elem => {
					elem.update()
				})
			}
			clear() {
				let x = this.process.canvas.width
				let y = this.process.canvas.height
				this.process.context.clearRect(0, 0, x, y)
			}
			draw() {
				this.elements.forEach(elem => {
					elem.draw()
				})
			}
		}

		class ParticleSystem {
			constructor(scene) {
				this.particles = []
				this.scene = scene
				this.setup()
			}
			setup() {
				// let p1 = new Particle()
				// let p2 = new Particle()
				// let p3 = new Particle()
				// let p4 = new Particle()

				// this.addParticle(p1)
				// this.addParticle(p2)
				// this.addParticle(p3)
				// this.addParticle(p4)
				this.addParticles()
			}
			addParticle(p) {
				p.scene = this.scene
				this.particles.push(p)
			}
			addParticles() {
				// p.scene = this.scene
				// this.particles.push(p)
				for (var i = 0; i < 6; i++) {
					let p = new Particle()
					this.addParticle(p)
				}
			}
			draw() {
				this.particles.forEach(p => p.draw())
				this.drawLines()
			}
			update() {
				this.particles.forEach(p => p.update())
			}
			drawLines() {
				// 这里性能可能有问题
				for (var i = 0; i < this.particles.length; i++) {
					let a = this.particles[i]
					for (var j = 0; j < this.particles.length; j++) {
						let b = this.particles[j]
						this.drawLineBetween(a, b)
					}
				}
			}
			drawLineBetween(a, b) {
				let ctx = this.scene.process.context
				ctx.strokeStyle = 'purple'
				ctx.lineWidth = 0.5
				ctx.beginPath()
				ctx.moveTo(a.x, a.y)
				ctx.lineTo(b.x, b.y)
				ctx.stroke()
			}
		}

		class Particle {
			constructor() {
				this.x = 0
				this.y = 0
				this.r = 0
				this.setup()
			}
			setup() {
				// 硬编码要不得
				const width = 800
				const height = 600

				this.r = randomBetween(4, 8)
				this.x = randomBetween(this.r, width - this.r)
				this.y = randomBetween(this.r, height - this.r)
				this.speedX = randomBetween(1, 3)
				this.speedY = randomBetween(1, 3)
				this.numbers = []
			}
			move() {
				this.x += this.speedX
				this.y += this.speedY
				if (this.x <= this.r || this.x >= 800 - this.r) {
					this.speedX *= -1
				}
				if (this.y <= this.r || this.y >= 600 - this.r) {
					this.speedY *= -1
				}
			}
			draw() {
				if (!this.scene) {
					return
				}
				let ctx = this.scene.process.context
				ctx.fillStyle = 'purple'
				ctx.beginPath()
				ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2, true)
				ctx.closePath()
				ctx.fill()
			}
			update() {
				this.move()
			}
		}

		function __main() {
			const p = new Process()
			const s = new Scene(p)
			p.runWithScene(s)
		}

		__main()
	</script>
</body>

</html>