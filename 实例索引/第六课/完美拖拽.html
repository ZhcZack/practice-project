<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>完美拖拽</title>
	<style>
		html,
		body {
			margin: 0;
			padding: 0;
			background-color: black;
			color: white;
		}

		#drag {
			border: 2px white solid;
			width: 300px;
			height: 200px;
			position: absolute;
			top: 200px;
			left: 200px;
		}

		.title {
			background-color: #222222;
			border-bottom: 2px white solid;
			text-align: right;
			font-size: 0.8em;
			cursor: move;
		}

		.title span {
			display: inline-block;
			cursor: pointer;
			padding: 5px;
		}

		.content {
			background-color: #333333;
			height: 150px;
			padding: 10px;
		}

		.content span {
			color: #ff0;
		}
	</style>
</head>

<body>
	<div id="drag">
		<div class="title">
			<span>点击回放拖动轨迹</span>
		</div>
		<div class="content">

		</div>
	</div>
	<script>
		function get(selector) {
			return document.querySelector(selector)
		}
		function getAll(selector) {
			return document.querySelectorAll(selector)
		}
		function log(msg) {
			console.log(msg)
		}

		function dragInformation() {
			return {
				title: get('#drag .title'),
				drag: get('#drag'),
				content: get('#drag .content'),
				playback: get('#drag .title span'),
				dragEnabled: false,
				isInPlaybackMode: false,
				diffX: 0,
				diffY: 0,
				points: []
			}
		}

		function updateStatus(content, dragInfo, dragElement) {
			content.innerHTML = 'Drag: <span>' + dragInfo + '</span><br><br>offsetTop: <span>' +
				dragElement.offsetTop + '</span><br><br>offsetLeft: <span>' +
				dragElement.offsetLeft + '</span>'
		}

		function updatePoints(points, newPoint) {
			points.push(newPoint)
		}

		function moveWithLimits(x, y, dx, dy, dragElement) {
			var d = dragElement
			if (x - dx <= 0) {
				d.style.left = 0
			} else if (d.offsetWidth + d.offsetLeft >= window.innerWidth) {
				d.style.left = window.innerWidth - d.offsetWidth + 'px'
			}

			if (y - dy <= 0) {
				d.style.top = 0
			} else if (d.offsetHeight + d.offsetTop >= window.innerHeight) {
				d.style.top = window.innerHeight - d.offsetHeight + 'px'
			}

		}

		function dragEvents(info) {
			var title = info.title
			var content = info.content
			var points = info.points
			var d = info.drag
			title.addEventListener('mousedown', function (e) {
				if (info.isInPlaybackMode) {
					return
				}
				info.dragEnabled = true
				var x = e.clientX
				var y = e.clientY
				info.diffX = x - d.offsetLeft
				info.diffY = y - d.offsetTop
				this.setCapture()
				updatePoints(points, [x, y])
			})
			title.addEventListener('mouseup', function (e) {
				if (info.isInPlaybackMode) {
					return
				}
				var x = e.clientX
				var y = e.clientY
				info.dragEnabled = false
				this.releaseCapture()
				updateStatus(content, info.dragEnabled, d)
			})
			window.addEventListener('mousemove', function (e) {
				if (!info.dragEnabled) {
					return
				}
				var x = e.clientX
				var y = e.clientY
				d.style.left = x - info.diffX + 'px'
				d.style.top = y - info.diffY + 'px'

				moveWithLimits(x, y, info.diffX, info.diffY, d)

				updateStatus(content, info.dragEnabled, d)
				updatePoints(info.points, [x, y])
			})
		}

		function playbackEvents(info) {
			var playback = info.playback
			var points = info.points
			var d = info.drag
			var content = info.content
			playback.addEventListener('mousedown', function (e) {
				var timer = setInterval(function () {
					info.isInPlaybackMode = true
					var p = points.pop()
					var x = p[0]
					var y = p[1]

					d.style.left = x - info.diffX + 'px'
					d.style.top = y - info.diffY + 'px'

					moveWithLimits(x, y, info.diffX, info.diffY, d)
					updateStatus(content, info.dragEnabled, d)
					if (points.length === 0) {
						clearInterval(timer)
						info.isInPlaybackMode = false
					}
				}, 1000 / 60)
				e.stopPropagation()
			})
			playback.addEventListener('mouseup', function (e) {
				e.stopPropagation()
			})

		}

		function main() {
			var info = dragInformation()
			updateStatus(info.content, info.dragEnabled, info.drag)
			dragEvents(info)
			playbackEvents(info)
		}

		main()
	</script>
</body>

</html>