<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>窗口推拽（改变大小-最小化-最大化-还原-关闭）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .drag {
            width: 400px;
            border: 1px solid black;
            border-radius: 5px;
            box-shadow: 0 0 2px gray;
            padding: 10px;
            position: absolute;
            left: 100px;
            top: 100px;
        }

        .drag .title {
            padding-bottom: 10px;
            border-bottom: 1px solid gray;
            position: relative;
            cursor: move;
        }

        .drag .title .title-buttons {
            display: inline;
            position: absolute;
            right: 0;
        }

        .drag .title .title-buttons span {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid gray;
            border-radius: 5px;
            cursor: pointer;
        }

        .drag .title .title-buttons .title-minsize-button {
            background-color: orange;
        }

        .drag .title .title-buttons .title-maxsize-button {
            background-color: green;
        }

        .drag .title .title-buttons .title-close-button {
            background-color: red;
        }

        .drag .content {
            padding: 10px;
        }

        .drag .content ol {
            margin-left: 10px;
        }

        .min {
            position: absolute;
            left: 100px;
            top: 100px;
            width: 20px;
            height: 20px;
            border-radius: 5px;
            background-color: skyblue;
            cursor: pointer;
        }

        .drag .resize {
            position: absolute;
        }

        .drag .resize-top {
            width: 100%;
            height: 10px;
            top: 0;
            left: 0;
            cursor: n-resize;
        }

        .drag .resize-bottom {
            width: 100%;
            height: 10px;
            bottom: 0;
            left: 0;
            cursor: n-resize;
        }
    </style>
</head>

<body>
    <div class="drag">
        <div class="resize resize-top"></div>
        <div class="resize resize-bottom"></div>
        <div class="title">
            <span class="title-text">这是一个可以拖动的窗口</span>
            <div class="title-buttons">
                <span class="title-minsize-button"></span>
                <span class="title-maxsize-button"></span>
                <span class="title-close-button"></span>
            </div>
        </div>
        <div class="content">
            <ol>
                <li> 窗口可以拖动；</li>
                <li>窗口可以通过八个方向改变大小；TODO</li>
                <li>窗口可以最小化、最大化、还原、关闭；</li>
                <li>限制窗口最小宽度/高度。</li>
            </ol>
        </div>
    </div>
    <script>
        window.addEventListener('load', function () {
            main()
        })

        var get = document.querySelector.bind(document)
        var getAll = document.querySelectorAll.bind(document)
        var log = console.log.bind(console)


        function main() {
            var drag = get('.drag')
            dragAndDrop(drag)
            titleButtonActions()
            resizeActions()
        }

        function resizeActions() {
            var isResizing = false
            var drag = get('.drag')
            var top = get('.resize-top')
            var startX = 0
            var startY = 0
            var minWidth = 400
            var maxWidth = window.innerWidth
            var minHeight = drag.offsetHeight
            var maxHeight = window.innerHeight

            // TODO: 这里是我想多了
            top.addEventListener('mousedown', function (e) {
                isResizing = true
                startY = e.clientY
                this.setCapture()
                e.stopPropagation()
            })
            top.addEventListener('mouseup', function (e) {
                isResizing = false
                this.releaseCapture()
                e.stopPropagation()
            })
            top.addEventListener('mouseout', function (e) {
                isResizing = false
                e.stopPropagation()
            })
            top.addEventListener('mousemove', function (e) {
                if (!isResizing) {
                    return
                }
                var diff = e.clientY - startY
                startY = e.clientY
                if (diff > 0) {
                    if (drag.offsetHeight <= minHeight) {
                        drag.style.height = minHeight + 'px'
                    } else {
                        drag.style.height = drag.offsetHeight - diff + 'px'
                        drag.style.top = drag.offsetTop + diff + 'px'
                    }
                } else {
                    if (drag.offsetHeight >= maxHeight) {
                        drag.style.height = maxHeight + 'px'
                    } else {
                        drag.style.height = drag.offsetHeight - diff + 'px'
                        drag.style.top = drag.offsetTop + diff + 'px'
                    }
                }
            })
        }

        function titleButtonActions() {
            var drag = get('.drag')
            var buttons = getAll('.title-buttons span')
            var minsize = buttons[0]
            var maxsize = buttons[1]
            var close = buttons[2]
            var t = null
            var dragInMaxSize = false

            minsize.addEventListener('click', function (e) {
                t = document.createElement('div')
                t.classList.add('min')
                document.body.appendChild(t)
                drag.style.display = 'none'

                t.addEventListener('click', function (e) {
                    this.parentNode.removeChild(t)
                    drag.style.display = 'block'
                    e.stopPropagation()
                })
                e.stopPropagation()
            })

            maxsize.addEventListener('click', function (e) {
                if (dragInMaxSize) {
                    drag.style.width = '400px'
                    drag.style.height = 'auto'
                    drag.style.top = '100px'
                    drag.style.left = '100px'
                    dragInMaxSize = false
                } else {
                    drag.style.width = window.innerWidth + 'px'
                    drag.style.height = window.innerHeight + 'px'
                    drag.style.left = 0
                    drag.style.top = 0
                    dragInMaxSize = true
                }
                e.stopPropagation()
            })

            close.addEventListener('click', function (e) {
                t = document.createElement('div')
                t.classList.add('min')
                document.body.appendChild(t)
                drag.style.display = 'none'

                t.addEventListener('click', function (e) {
                    this.parentNode.removeChild(t)
                    drag.style.display = 'block'
                    e.stopPropagation()
                })
                e.stopPropagation()

            })
        }

        function dragAndDrop(item) {
            var isDrag = false
            var dx = 0
            var dy = 0
            item.addEventListener('mousedown', function (e) {
                isDrag = true
                dx = e.clientX - this.offsetLeft
                dy = e.clientY - this.offsetTop
                this.setCapture()
            })
            item.addEventListener('mouseup', function (e) {
                isDrag = false
                this.releaseCapture()
            })
            item.addEventListener('mousemove', function (e) {
                if (!isDrag) {
                    return
                }
                this.style.left = e.clientX - dx + 'px'
                this.style.top = e.clientY - dy + 'px'
                dragWithLimits()
            })
        }

        function dragWithLimits() {
            var drag = get('.drag')
            if (drag.offsetLeft <= 0) {
                drag.style.left = 0
            } else if (drag.offsetLeft + drag.offsetWidth >= window.innerWidth) {
                drag.style.left = window.innerWidth - drag.offsetWidth + 'px'
            }

            if (drag.offsetTop <= 0) {
                drag.style.top = 0
            } else if (drag.offsetTop + drag.offsetHeight >= window.innerHeight) {
                drag.style.top = window.innerHeight - drag.offsetHeight + 'px'
            }
        }
    </script>
</body>

</html>