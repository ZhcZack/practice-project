<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>拼图小游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .imglist {
            list-style-type: none;
        }

        .imglist li {
            width: 100px;
            height: 100px;
            border-radius: 5px;
            border: 2px solid yellow;
            opacity: 0.5;
            overflow: hidden;
            display: inline-block;
        }

        .imglist li.selected {
            opacity: 1;
        }

        .box {
            list-style-type: none;
            width: 410px;
            height: 570px;
            overflow: hidden;
            font-size: 0;
            position: relative;
        }

        .box li {
            display: inline-block;
            position: relative;
            z-index: 3;
        }

        .box li.already {
            z-index: 2;
        }

        .box li.item {
            border: 2px dashed yellow;
        }

        .box .mark {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: url(http://www.fgm.cc/learn/lesson9/img/girl0/bg.png) no-repeat;
            z-index: 1;
        }
    </style>
</head>

<body>
    <ul class="imglist">
        <li class="selected">
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/girl.jpg" alt="girl0">
        </li>
    </ul>
    <button>开始游戏</button>
    <ul class="box">
        <div class="mark"></div>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/1.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/2.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/3.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/4.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/5.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/6.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/7.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/8.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/9.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/10.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/11.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/12.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/13.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/14.png" alt="">
        </li>
        <li>
            <img src="http://www.fgm.cc/learn/lesson9/img/girl0/15.png" alt="">
        </li>
    </ul>
    <script>
        window.addEventListener('load', function () {
            main()
        })

        var get = document.querySelector.bind(document)
        var getAll = document.querySelectorAll.bind(document)
        var log = console.log.bind(console)

        function main() {
            var button = get('button')
            var game = PuzzleGame('.box')
            button.addEventListener('click', function () {
                if (game.started) {
                    game.restart()
                } else {
                    game.start()
                    this.textContent = '重新开始'
                }
            })
        }

        function PuzzleGame(identifier) {
            var o = {}
            o.identifier = identifier
            o.box = get(identifier)
            o.puzzles = getAll(identifier + ' li')
            o.started = false

            // timers for moving
            o.itemMoveTimer = null
            o.chosenMoveTimer = null

            // init puzzles style,  position and mouse events
            o.setup = function () {
                // style and position
                var w = this.puzzles[0].offsetWidth
                var h = this.puzzles[0].offsetHeight
                var baseHref = 'http://www.fgm.cc/learn/lesson9/img/girl0/'
                var hrefArray = []
                for (var i = 0; i < this.puzzles.length; i++) {
                    this.puzzles[i].style.position = 'absolute'
                    this.puzzles[i].dataset.move = i
                    this.puzzles[i].style.zIndex = 3;
                    this.puzzles[i].classList.remove('already')
                    this.puzzles[i].removeEventListener('mousedown', this.mousedownEvent)
                    this.puzzles[i].removeEventListener('mousemove', this.mousemoveEvent)
                    this.puzzles[i].removeEventListener('mouseup', this.mouseupEvent)
                    if (i <= 4) {
                        this.puzzles[i].style.top = 0
                        this.puzzles[i].style.left = i * w + 'px'
                    } else if (i >= 5 && i <= 9) {
                        this.puzzles[i].style.top = h + 'px'
                        this.puzzles[i].style.left = (i - 5) * w + 'px'
                    } else {
                        this.puzzles[i].style.top = h * 2 + 'px'
                        this.puzzles[i].style.left = (i - 10) * w + 'px'
                    }
                    hrefArray.push(i)
                }
                hrefArray.sort(function (a, b) {
                    return Math.random() > 0.5 ? 1 : -1
                })
                for (var i = 0; i < hrefArray.length; i++) {
                    this.puzzles[i].dataset.index = hrefArray[i]
                    var img = this.puzzles[i].querySelector('img')
                    img.src = baseHref + (hrefArray[i] + 1) + '.png'
                }
            }

            // game end
            o.end = function () {
                var baseHref = 'http://www.fgm.cc/learn/lesson9/img/girl0/'

                this.started = false
                for (var i = 0; i < this.puzzles.length; i++) {
                    this.puzzles[i].querySelector('img').src = baseHref + (i + 1) + '.png'
                    this.puzzles[i].style.cssText = ''
                    this.puzzles[i].removeAttribute('data-index')
                    this.puzzles[i].removeAttribute('data-move')
                    this.puzzles[i].className = ''
                    this.puzzles[i].removeEventListener('mousedown', this.mousedownEvent)
                    this.puzzles[i].removeEventListener('mousemove', this.mousemoveEvent)
                    this.puzzles[i].removeEventListener('mouseup', this.mouseupEvent)
                }
                alert('Game end!')
            }

            // game start
            o.start = function () {
                // game start
                this.started = true

                this.setup()

                // mouse events
                this.isDrag = false
                this.isMoving = false
                this.startX = 0
                this.startY = 0
                this.maxWidth = o.box.offsetWidth
                this.maxHeight = o.box.offsetHeight

                for (var i = 0; i < o.puzzles.length; i++) {
                    this.puzzles[i].addEventListener('mousedown', this.mousedownEvent)
                    this.puzzles[i].addEventListener('mousemove', this.mousemoveEvent)
                    this.puzzles[i].addEventListener('mouseup', this.mouseupEvent)
                }
            }

            // restart puzzle game
            o.restart = function () {
                this.setup()
            }

            // prevent puzzle out of box's boundary
            o.moveWithLimits = function (obj) {
                // move with limits
                if (obj.offsetLeft <= 0) {
                    obj.style.left = 0
                } else if (obj.offsetLeft + obj.offsetWidth >= this.maxWidth) {
                    obj.style.left = this.maxWidth - obj.offsetWidth + 'px'
                }
                if (obj.offsetTop <= 0) {
                    obj.style.top = 0
                } else if (obj.offsetTop + obj.offsetHeight >= this.maxHeight) {
                    obj.style.top = this.maxHeight - obj.offsetHeight + 'px'
                }
            }

            // declare the puzzle moving with mouse is puzzle 'chosen'
            // check which puzzle of puzzles left in box is the puzzle 'item', 
            // which will change position with puzzle 'chosen'
            o.identifyMovingPuzzles = function (obj, x, y) {
                // obj is the puzzle 'chosen'
                // x, y is the mouse coordinate
                for (var j = 0; j < this.puzzles.length; j++) {
                    this.puzzles[j].classList.remove('chosen')
                    obj.classList.add('chosen')
                    this.puzzles[j].classList.remove('item')
                    var rect = this.puzzles[j].getBoundingClientRect()
                    if (x >= rect.left && x <= rect.left + rect.width) {
                        if (y >= rect.top && y <= rect.top + rect.height) {
                            // log('-----before----------')
                            // log('mouse x: ' + e.clientX + ', mouse y: ' + e.clientY)
                            // log('li left: ' + rect.left + ', li right: ' + rect.right)
                            // log('li top: ' + rect.top + ', li bottom: ' + rect.bottom)
                            // log('-----after----------')
                            if (!this.puzzles[j].classList.contains('already')) {
                                this.puzzles[j].classList.add('item')
                            }
                            obj.classList.remove('item')
                        }
                    }
                }
            }

            // determine every puzzles is on its right position
            o.puzzleIsOnRightPosition = function () {
                var targetLength = this.puzzles.length
                var length = 0
                // 判断puzzle是否处于正确的位置上
                for (var i = 0; i < this.puzzles.length; i++) {
                    if (this.puzzles[i].dataset.move === this.puzzles[i].dataset.index) {
                        this.puzzles[i].classList.add('already')
                        length++
                    }
                }
                if (length === targetLength) {
                    this.end()
                }
            }

            // puzzle 'chosen' move back to its original position
            o.restorePuzzle = function (obj) {
                // log('not have item')
                // js bad part
                var self = this
                // 只有拖动的那一块可以移动的情况
                var startX = 0
                var startY = 0
                var index = Number(obj.dataset.move)
                var w = obj.offsetWidth
                var h = obj.offsetHeight
                if (index >= 0 && index <= 4) {
                    startX = index * w
                    startY = 0
                } else if (index >= 5 && index <= 9) {
                    startX = (index - 5) * w
                    startY = h
                } else {
                    startX = (index - 10) * w
                    startY = h * 2
                }
                // log(x, y)
                clearInterval(this.chosenMoveTimer)
                this.chosenMoveTimer = setInterval(function () {
                    var speedX = (startX - obj.offsetLeft) / 10
                    var speedY = (startY - obj.offsetTop) / 10
                    if (speedX > 0) {
                        speedX = Math.ceil(speedX)
                    } else {
                        speedX = Math.floor(speedX)
                    }
                    if (speedY > 0) {
                        speedY = Math.ceil(speedY)
                    } else {
                        speedY = Math.floor(speedY)
                    }
                    if (speedX === 0 && speedY === 0) {
                        self.isMoving = false
                        clearInterval(self.chosenMoveTimer)
                        obj.classList.remove('chosen')
                    }
                    // log(speedX, speedY)
                    obj.style.left = obj.offsetLeft + speedX + 'px'
                    obj.style.top = obj.offsetTop + speedY + 'px'
                }, 1000 / 60)
            }

            // puzzle 'chosen' and puzzle 'item' change positions with other
            o.puzzlesMoving = function (item, chosen) {
                // 两块puzzle都可以移动的情况

                // js bad part
                var self = this
                // 需要写清楚开始和结束的坐标
                // start是chosen元素
                // end是item元素
                var startX = 0
                var startY = 0
                var endX = item.offsetLeft
                var endY = item.offsetTop
                var chosenIndex = Number(chosen.dataset.move)
                var itemIndex = Number(item.dataset.move)
                var w = chosen.offsetWidth
                var h = chosen.offsetHeight
                if (chosenIndex >= 0 && chosenIndex <= 4) {
                    startX = chosenIndex * w
                    startY = 0
                } else if (chosenIndex >= 5 && chosenIndex <= 9) {
                    startX = (chosenIndex - 5) * w
                    startY = h
                } else {
                    startX = (chosenIndex - 10) * w
                    startY = h * 2
                }

                clearInterval(this.itemMoveTimer)
                this.itemMoveTimer = setInterval(function () {
                    var speedX = (startX - item.offsetLeft) / 10
                    var speedY = (startY - item.offsetTop) / 10
                    if (speedX > 0) {
                        speedX = Math.ceil(speedX)
                    } else {
                        speedX = Math.floor(speedX)
                    }
                    if (speedY > 0) {
                        speedY = Math.ceil(speedY)
                    } else {
                        speedY = Math.floor(speedY)
                    }
                    item.style.left = item.offsetLeft + speedX + 'px'
                    item.style.top = item.offsetTop + speedY + 'px'
                    if (speedX === 0 && speedY === 0) {
                        self.isMoving = false
                        clearInterval(self.itemMoveTimer)
                        item.classList.remove('item')
                        // 更新拼图位置信息
                        item.dataset.move = chosenIndex
                        self.puzzleIsOnRightPosition()
                    }
                }, 1000 / 60)

                clearInterval(this.chosenMoveTimer)
                this.chosenMoveTimer = setInterval(function () {
                    var speedX = (endX - chosen.offsetLeft) / 10
                    var speedY = (endY - chosen.offsetTop) / 10
                    if (speedX > 0) {
                        speedX = Math.ceil(speedX)
                    } else {
                        speedX = Math.floor(speedX)
                    }
                    if (speedY > 0) {
                        speedY = Math.ceil(speedY)
                    } else {
                        speedY = Math.floor(speedY)
                    }
                    chosen.style.left = chosen.offsetLeft + speedX + 'px'
                    chosen.style.top = chosen.offsetTop + speedY + 'px'
                    if (speedX === 0 && speedY === 0) {
                        self.isMoving = false
                        clearInterval(self.chosenMoveTimer)
                        chosen.classList.remove('chosen')
                        // 更新拼图位置信息
                        chosen.dataset.move = itemIndex
                        self.puzzleIsOnRightPosition()
                    }
                }, 1000 / 60)
            }

            o.mousedownEvent = function (e) {
                o.isDrag = true
                o.startX = e.clientX
                o.startY = e.clientY
                // this.setCapture()
                e.stopPropagation()
                e.preventDefault()
            }

            o.mousemoveEvent = function (e) {
                if (!o.isDrag) {
                    return
                }
                if (o.isMoving) {
                    return
                }
                if (this.classList.contains('already')) {
                    return
                }
                var dx = e.clientX - o.startX
                var dy = e.clientY - o.startY
                o.startX = e.clientX
                o.startY = e.clientY
                this.style.left = this.offsetLeft + dx + 'px'
                this.style.top = this.offsetTop + dy + 'px'
                this.style.zIndex = parseInt(this.style.zIndex, 10) + 1

                o.moveWithLimits(this)
                o.identifyMovingPuzzles(this, e.clientX, e.clientY)
                e.stopPropagation()
            }

            o.mouseupEvent = function (e) {
                o.isDrag = false
                if (o.isMoving) {
                    return
                }
                // this.releaseCapture()
                e.stopPropagation()
                e.preventDefault()

                // puzzle move
                var chosen = get('.box .chosen')
                var item = get('.box .item')
                var itemMoveTimer = null
                var chosenMoveTimer = null

                if (!chosen) {
                    return
                }
                o.isMoving = true
                if (item) {
                    o.puzzlesMoving(item, chosen)
                } else {
                    o.restorePuzzle(chosen)
                }
            }

            return o
        }
    </script>
</body>

</html>