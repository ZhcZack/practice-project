<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>照片墙——多实例演示（面向对象版）</title>
    <style>
        .photo-wall {
            width: 840px;
            background-color: #EEEEEE;
            padding: 0 0 30px 0;
            border: 1px solid #C3C3C3;
            margin: auto;
            margin-bottom: 30px;
        }

        .photo-wall .title {
            position: relative;
            background-color: #fafafa;
            border-bottom: 1px solid #C3C3C3;
            padding: 5px;
        }

        .photo-wall .random-display {
            float: right;
        }

        .imglist {
            padding: 0;
            margin: 0;
            font-size: 0;
            position: relative;
            left: 10px;
            top: 10px;
        }

        .imglist li {
            display: inline-block;
            padding: 5px;
            background-color: white;
            border: 1px solid gray;
            cursor: move;
        }

        .imglist li.item {
            border: 1px dashed red;
        }

        .imglist li img {
            width: 140px;
            height: 105px;
        }
    </style>
</head>

<body>
    <div class="photo-wall">
        <div class="title">
            <span>一堆90后</span>
            <a href="javascript:void(0)" class="random-display">随机排序</a>
        </div>
        <ul class="imglist">
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/0.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/1.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/2.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/3.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/4.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/5.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/6.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/7.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/8.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/9.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/10.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/11.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/12.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/13.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/14.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/15.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/16.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/17.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/18.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/19.jpg">
            </li>
        </ul>
    </div>
    <div class="photo-wall photo-wall-2">
        <div class="title">
            <span>一堆90后</span>
            <a href="javascript:void(0)" class="random-display">随机排序</a>
        </div>
        <ul class="imglist">
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/0.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/1.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/2.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/3.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/4.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/5.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/6.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/7.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/8.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/9.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/10.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/11.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/12.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/13.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/14.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/15.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/16.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/17.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/18.jpg">
            </li>
            <li>
                <img src="http://www.fgm.cc/learn/lesson10/img/photo/19.jpg">
            </li>
        </ul>
    </div>
    <script>
        var get = document.querySelector.bind(document)
        var getAll = document.querySelectorAll.bind(document)
        var log = console.log.bind(console)
        window.addEventListener('load', main)

        function main() {
            // bad code, improvement required. start with PuzzleGame
            var game1 = PuzzleGame('.photo-wall')
            var game2 = PuzzleGame('.photo-wall-2')
            var btn1 = getAll('.random-display')[0]
            var btn2 = getAll('.random-display')[1]
            btn1.addEventListener('click', function () {
                game1.randomDisplay()
            })
            btn2.addEventListener('click', function () {
                game2.randomDisplay()
            })
        }

        // many places to fix (fixed)
        // todo: 
        // -- multiple photo wall
        // -- add random display button
        // todo done
        function PuzzleGame(id) {
            var o = {}
            o.identifier = identifier
            o.box = get(identifier)
            o.puzzles = o.box.querySelectorAll('li')
            o.started = false

            // timers for moving
            o.timer = null
            // random display timers
            o.timers = []

            // css function
            o.css = function (obj, attr, value) {
                if (arguments.length === 2) {
                    var style = window.getComputedStyle(obj)
                    return parseFloat(style[attr])
                } else if (arguments.length === 3) {
                    if (attr === 'opacity') {
                        obj.style.opacity = value / 100
                    } else {
                        obj.style[attr] = value + 'px'
                    }
                } else {
                    alert('css function parameter error')
                }
            }

            // init puzzles style,  position and mouse events
            o.setup = function () {
                // style and position
                var w = this.puzzles[0].offsetWidth
                var h = this.puzzles[0].offsetHeight
                var maxHeight = this.box.offsetHeight
                var margin = 10

                this.box.style.height = maxHeight + 'px'
                for (var i = 0; i < this.puzzles.length; i++) {
                    this.puzzles[i].style.position = 'absolute'
                    this.puzzles[i].dataset.move = i
                    if (i <= 4) {
                        this.puzzles[i].style.top = 0 + 'px'
                        this.puzzles[i].style.left = i * w + margin * i + 'px'
                    } else if (i >= 5 && i <= 9) {
                        this.puzzles[i].style.top = h + margin + 'px'
                        this.puzzles[i].style.left = (i - 5) * w + margin * (i - 5) + 'px'
                    } else if (i >= 10 && i <= 14) {
                        this.puzzles[i].style.top = h * 2 + margin * 2 + 'px'
                        this.puzzles[i].style.left = (i - 10) * w + margin * (i - 10) + 'px'
                    } else {
                        this.puzzles[i].style.top = h * 3 + margin * 3 + 'px'
                        this.puzzles[i].style.left = (i - 15) * w + margin * (i - 15) + 'px'
                    }
                }

                // mouse events
                this.isDrag = false
                this.isMoving = false
                this.startX = 0
                this.startY = 0
                this.maxWidth = o.box.offsetWidth
                this.maxHeight = o.box.offsetHeight

                for (var i = 0; i < o.puzzles.length; i++) {
                    this.puzzles[i].addEventListener('mousedown', this.mousedownEvent)
                    this.puzzles[i].addEventListener('mousemove', this.mousemoveEvent)
                    this.puzzles[i].addEventListener('mouseup', this.mouseupEvent)
                }
            }

            o.randomDisplay = function () {
                var length = this.puzzles.length
                var number = length - 4 // 16 -- same as hard code
                var ps = []
                while (ps.length !== number) {
                    var n = Math.ceil(Math.random() * (length - 1))
                    if (ps.indexOf(n) >= 0) {
                        n = Math.ceil(Math.random() * (length - 1))
                    } else {
                        ps.push(n)
                    }
                }
                log(ps)
                this.timers = Array(ps.length / 2)
                for (var i = 0; i < this.timers.length; i++) {
                    this.puzzlesMoving(this.puzzles[ps.shift()], this.puzzles[ps.pop()], this.timers[i])
                }
            }

            // restart puzzle game
            o.restart = function () {
                this.setup()
            }

            // prevent puzzle out of box's boundary
            o.moveWithLimits = function (obj) {
                var margin = 10
                var maxWidth = this.css(this.box, 'width') - margin
                var maxHeight = this.css(this.box, 'height')
                // move with limits
                if (obj.offsetLeft <= 0) {
                    this.css(obj, 'left', 0)
                } else if (obj.offsetLeft + obj.offsetWidth >= maxWidth) {
                    // obj.style.left = this.maxWidth - obj.offsetWidth + 'px'
                    this.css(obj, 'left', maxWidth - obj.offsetWidth)
                }
                if (obj.offsetTop <= 0) {
                    obj.style.top = 0
                } else if (obj.offsetTop + obj.offsetHeight >= maxHeight - 20) {
                    obj.style.top = maxHeight - obj.offsetHeight - 20 + 'px'
                }
            }

            // declare the puzzle moving with mouse is puzzle 'chosen'
            // check which puzzle of puzzles left in box is the puzzle 'item', 
            // which will change position with puzzle 'chosen'
            o.identifyMovingPuzzles = function (obj, x, y) {
                // obj is the puzzle 'chosen'
                // x, y is the mouse coordinate
                for (var j = 0; j < this.puzzles.length; j++) {
                    this.puzzles[j].classList.remove('chosen')
                    obj.classList.add('chosen')
                    this.puzzles[j].classList.remove('item')
                    var rect = this.puzzles[j].getBoundingClientRect()
                    if (x >= rect.left && x <= rect.left + rect.width) {
                        if (y >= rect.top && y <= rect.top + rect.height) {
                            // log('-----before----------')
                            // log('mouse x: ' + e.clientX + ', mouse y: ' + e.clientY)
                            // log('li left: ' + rect.left + ', li right: ' + rect.right)
                            // log('li top: ' + rect.top + ', li bottom: ' + rect.bottom)
                            // log('-----after----------')
                            this.puzzles[j].classList.add('item')
                            obj.classList.remove('item')
                        }
                    }
                }
            }

            // puzzle 'chosen' move back to its original position
            o.restorePuzzle = function (obj) {
                // log('not have item')
                // js bad part
                var self = this
                // 只有拖动的那一块可以移动的情况
                var startX = 0
                var startY = 0
                var index = Number(obj.dataset.move)
                var margin = 10
                var w = obj.offsetWidth
                var h = obj.offsetHeight
                if (index <= 4) {
                    startX = index * w + margin * index
                    startY = 0
                } else if (index >= 5 && index <= 9) {
                    startX = (index - 5) * w + margin * (index - 5)
                    startY = h + margin
                } else if (index >= 10 && index <= 14) {
                    startX = (index - 10) * w + margin * (index - 10)
                    startY = h * 2 + margin * 2
                } else {
                    startX = (index - 15) * w + (index - 15) * margin
                    startY = h * 3 + margin * 3
                }
                // log(x, y)
                clearInterval(this.timer)
                this.timer = setInterval(function () {
                    var speedX = (startX - obj.offsetLeft) / 10
                    var speedY = (startY - obj.offsetTop) / 10
                    if (speedX > 0) {
                        speedX = Math.ceil(speedX)
                    } else {
                        speedX = Math.floor(speedX)
                    }
                    if (speedY > 0) {
                        speedY = Math.ceil(speedY)
                    } else {
                        speedY = Math.floor(speedY)
                    }
                    if (speedX === 0 && speedY === 0) {
                        self.isMoving = false
                        clearInterval(self.timer)
                        obj.classList.remove('chosen')
                    }
                    // log(speedX, speedY)
                    obj.style.left = obj.offsetLeft + speedX + 'px'
                    obj.style.top = obj.offsetTop + speedY + 'px'
                }, 1000 / 60)
            }

            // puzzle 'chosen' and puzzle 'item' change positions with other
            o.puzzlesMoving = function (item, chosen, timer) {
                // 两块puzzle都可以移动的情况

                if (!timer) {
                    timer = this.timer
                }
                // js bad part
                var self = this
                // 需要写清楚开始和结束的坐标
                // start是chosen元素
                // end是item元素
                var startX = 0
                var startY = 0
                var endX = item.offsetLeft
                var endY = item.offsetTop
                var chosenIndex = Number(chosen.dataset.move)
                var itemIndex = Number(item.dataset.move)
                var w = chosen.offsetWidth
                var h = chosen.offsetHeight
                var margin = 10

                if (chosenIndex <= 4) {
                    startX = chosenIndex * w + margin * chosenIndex
                    startY = 0
                } else if (chosenIndex >= 5 && chosenIndex <= 9) {
                    startX = (chosenIndex - 5) * w + margin * (chosenIndex - 5)
                    startY = h + margin
                } else if (chosenIndex >= 10 && chosenIndex <= 14) {
                    startX = (chosenIndex - 10) * w + margin * (chosenIndex - 10)
                    startY = h * 2 + margin * 2
                } else {
                    startX = (chosenIndex - 15) * w + (chosenIndex - 15) * margin
                    startY = h * 3 + margin * 3
                }

                clearInterval(timer)
                timer = setInterval(function () {
                    var itemSpeedX = (startX - item.offsetLeft) / 10
                    var itemSpeedY = (startY - item.offsetTop) / 10
                    if (itemSpeedX > 0) {
                        itemSpeedX = Math.ceil(itemSpeedX)
                    } else {
                        itemSpeedX = Math.floor(itemSpeedX)
                    }
                    if (itemSpeedY > 0) {
                        itemSpeedY = Math.ceil(itemSpeedY)
                    } else {
                        itemSpeedY = Math.floor(itemSpeedY)
                    }

                    var chosenSpeedX = (endX - chosen.offsetLeft) / 10
                    var chosenSpeedY = (endY - chosen.offsetTop) / 10
                    if (chosenSpeedX > 0) {
                        chosenSpeedX = Math.ceil(chosenSpeedX)
                    } else {
                        chosenSpeedX = Math.floor(chosenSpeedX)
                    }
                    if (chosenSpeedY > 0) {
                        chosenSpeedY = Math.ceil(chosenSpeedY)
                    } else {
                        chosenSpeedY = Math.floor(chosenSpeedY)
                    }

                    item.style.left = item.offsetLeft + itemSpeedX + 'px'
                    item.style.top = item.offsetTop + itemSpeedY + 'px'
                    chosen.style.left = chosen.offsetLeft + chosenSpeedX + 'px'
                    chosen.style.top = chosen.offsetTop + chosenSpeedY + 'px'
                    if (chosenSpeedX === 0 && chosenSpeedY === 0 &&
                        itemSpeedX === 0 && itemSpeedY === 0) {
                        self.isMoving = false
                        clearInterval(timer)
                        item.classList.remove('item')
                        chosen.classList.remove('chosen')
                        // 更新拼图位置信息
                        item.dataset.move = chosenIndex
                        chosen.dataset.move = itemIndex
                    }


                }, 1000 / 60)
            }

            o.mousedownEvent = function (e) {
                if (o.isMoving) {
                    return
                }
                o.isDrag = true
                o.startX = e.clientX
                o.startY = e.clientY
                this.setCapture()
                e.stopPropagation()
            }

            o.mousemoveEvent = function (e) {
                if (!o.isDrag) {
                    return
                }
                var dx = e.clientX - o.startX
                var dy = e.clientY - o.startY
                o.startX = e.clientX
                o.startY = e.clientY
                o.css(this, 'left', o.css(this, 'left') + dx)
                o.css(this, 'top', o.css(this, 'top') + dy)

                o.moveWithLimits(this)
                o.identifyMovingPuzzles(this, e.clientX, e.clientY)
                e.stopPropagation()
            }

            o.mouseupEvent = function (e) {
                o.isDrag = false
                this.releaseCapture()
                e.stopPropagation()

                // puzzle move
                var chosen = get(o.identifier + ' .chosen')
                var item = get(o.identifier + ' .item')
                var itemMoveTimer = null
                var chosenMoveTimer = null

                if (!chosen) {
                    return
                }
                o.isMoving = true
                if (item) {
                    o.puzzlesMoving(item, chosen)
                } else {
                    o.restorePuzzle(chosen)
                }
            }

            o.setup()

            return o
        }
    </script>
</body>

</html>