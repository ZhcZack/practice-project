<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>移动效果（按轨迹移动）</title>
	<style>
		.item {
			position: absolute;
			top: 200px;
			left: 50px;
		}
	</style>
</head>

<body>
	<button>根据鼠标点击位置移动</button>
	<button>根据鼠标轨迹移动</button>
	<p>请点击按钮激活功能！</p>
	<h2>代码写的一团糟而且还有问题，以后重构吧。</h2>
	<img src="http://www.fgm.cc/learn/lesson7/img/1.gif" class="item">
	<script>
		var getAll = document.querySelectorAll.bind(document)
		var get = document.querySelector.bind(document)
		var log = console.log.bind(console)

		function main() {
			buttonActions()
		}

		function buttonActions() {
			var buttons = getAll('button')
			var p = get('p')
			var drawActions = drawMoveAction()

			buttons[0].addEventListener('click', function (e) {
				refreshUI('first')
				clickToMoveEnabled()
				drawMovingPathDisalbed(drawActions)
				e.stopPropagation()
			})
			buttons[1].addEventListener('click', function (e) {
				refreshUI('second')
				clickToMoveDisabled()
				drawMovingPathEnabled(drawActions)
				e.stopPropagation()
			})
		}

		function itemImageChange() {
			var item = get('.item')
			var imgs = ['http://www.fgm.cc/learn/lesson7/img/1.gif',
				'http://www.fgm.cc/learn/lesson7/img/2.gif']
			var current = item.src
			var index = imgs.indexOf(current)
			index++
			if (index > imgs.length - 1) {
				index = 0
			}
			item.src = imgs[index]
		}

		function drawMoveAction() {
			var points = []
			var timer = null
			var item = get('.item')
			var isInDrawMode = false

			return {
				drawPathMouseDown: drawPathMouseDown,
				drawPathMouseUp: drawPathMouseUp,
				drawPathMouseMove: drawPathMouseMove
			}

			function drawPathMouseDown(e) {
				isInDrawMode = true
				var x = e.clientX
				var y = e.clientY
				points.push([x, y])
			}

			function drawPathMouseUp(e) {
				isInDrawMode = false
				drawPathMove(item, points, timer)
			}

			function drawPathMouseMove(e) {
				if (!isInDrawMode) {
					return
				}
				var x = e.clientX
				var y = e.clientY
				points.push([x, y])
			}


			function drawPathMove(moveItem, path, timer) {
				itemImageChange()
				timer = setInterval(function () {
					if (path.length < 1) {
						clearInterval(timer)
						itemImageChange()
						return
					}
					var p = path.shift()
					moveItem.style.left = p[0] + 'px'
					moveItem.style.top = p[1] + 'px'
					if (path.length < 1) {
						clearInterval(timer)
						itemImageChange()
					}
				}, 1000 / 60)
			}
		}

		function drawMovingPathEnabled(actions) {
			// var actions = drawMoveAction()
			window.addEventListener('mousedown', actions.drawPathMouseDown);
			window.addEventListener('mouseup', actions.drawPathMouseUp)
			window.addEventListener('mousemove', actions.drawPathMouseMove)
		}

		function drawMovingPathDisalbed(actions) {
			// var actions = drawMoveAction()
			window.removeEventListener('mousedown', actions.drawPathMouseDown);
			window.removeEventListener('mouseup', actions.drawPathMouseUp)
			window.removeEventListener('mousemove', actions.drawPathMouseMove)
		}

		function clickMoveAction(e) {
			var item = get('.item')
			var timerX = null
			var timerY = null
			var duration = 2 // second

			var x = e.clientX
			var y = e.clientY

			var startX = item.offsetLeft
			var startY = item.offsetTop

			var dx = x - startX
			var dy = y - startY

			var speedX = 5
			var speedY = 5
			// clickMoveInXWithStableSpeed(item, dx, Math.abs(dx / duration / 30), timerX)
			// clickMoveInYWithStableSpeed(item, dy, Math.abs(dy / duration / 30), timerY)

			clickMoveInXWithChangedSpeed(item, x, timerX)
			clickMoveInYWithChangedSpeed(item, y, timerY)

			function clickMoveInXWithStableSpeed(moveItem, distance, speed, timer) {
				itemImageChange()
				var end = moveItem.offsetLeft + distance
				clearInterval(timer)
				timer = setInterval(function () {
					if (distance >= 0) {
						moveItem.style.left = moveItem.offsetLeft + speed + 'px'
						distance -= speed
					} else {
						moveItem.style.left = moveItem.offsetLeft - speed + 'px'
						distance += speed
					}
					if (Math.abs(distance - speed) <= speed) {
						clearInterval(timer)
						moveItem.style.left = end + 'px'
						itemImageChange()
					}
				}, 1000 / 60)
			}

			function clickMoveInYWithStableSpeed(moveItem, distance, speed, timer) {
				var end = moveItem.offsetTop + distance
				clearInterval(timer)
				timer = setInterval(function () {
					if (distance >= 0) {
						moveItem.style.top = moveItem.offsetTop + speed + 'px'
						distance -= speed
					} else {
						moveItem.style.top = moveItem.offsetTop - speed + 'px'
						distance += speed
					}
					if (Math.abs(distance - speed) <= speed) {
						clearInterval(timer)
						moveItem.style.top = end + 'px'
					}
				}, 1000 / 60)
			}

			function clickMoveInXWithChangedSpeed(moveItem, target, timer) {
				itemImageChange()
				clearInterval(timer)
				timer = setInterval(function () {
					var speed = (target - moveItem.offsetLeft) / 10
					if (speed > 0) {
						speed = Math.ceil(speed)
					} else {
						speed = Math.floor(speed)
					}
					if (speed === 0) {
						clearInterval(timer)
						itemImageChange()
					} else {
						moveItem.style.left = moveItem.offsetLeft + speed + 'px'
					}
				}, 1000 / 60)
			}

			function clickMoveInYWithChangedSpeed(moveItem, target, timer) {
				clearInterval(timer)
				timer = setInterval(function () {
					var speed = (target - moveItem.offsetTop) / 10
					if (speed > 0) {
						speed = Math.ceil(speed)
					} else {
						speed = Math.floor(speed)
					}
					if (speed === 0) {
						clearInterval(timer)
					} else {
						moveItem.style.top = moveItem.offsetTop + speed + 'px'
					}
				}, 1000 / 60)
			}
		}

		function clickToMoveEnabled() {
			window.addEventListener('click', clickMoveAction)
		}
		function clickToMoveDisabled() {
			window.removeEventListener('click', clickMoveAction)
		}

		function refreshUI(order) {
			var buttons = getAll('button')
			var p = get('p')
			var t1 = '根据鼠标点击位置移动'
			var t2 = '根据鼠标轨迹移动'
			var p1 = '鼠标点击页面， 人物将移动至鼠标位置！'
			var p2 = '按住鼠标左键，在页面划动，人物将按照鼠标轨迹移动。'
			switch (order) {
				case 'first':
					buttons[0].textContent = t1 + '（已激活）'
					buttons[1].textContent = t2
					p.textContent = p1
					break
				case 'second':
					buttons[0].textContent = t1
					buttons[1].textContent = t2 + '（已激活）'
					p.textContent = p2
					break
				default:
					break
			}
		}

		main()
	</script>
</body>

</html>